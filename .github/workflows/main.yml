name: Deploy Angular App to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Explicitly set permissions for GITHUB_TOKEN
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use GITHUB_TOKEN instead of PAT_TOKEN for checkout
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false # Don't persist the credentials

      - name: Set Git identity for private repo
        run: |
          git config --global url."https://${{ secrets.PAT_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18 # Using a stable LTS version of Node.js

      - name: Install dependencies
        run: npm install

      - name: Build Angular app
        run: |
          npm install -g @angular/cli
          ng build --configuration production --base-href "https://${{ github.repository_owner }}.github.io/Portfolio/"

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.PAT_TOKEN }} # Use PAT for deployment
          folder: dist/Portfolio # Make sure this path matches your Angular output folder
          branch: gh-pages # The branch the action should deploy to
          clean: true # Automatically remove deleted files
          commit-message: "Deploy: ${{ github.event.head_commit.message || 'Update site' }}"
